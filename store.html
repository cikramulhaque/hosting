<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Store Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{background:#0d0d0d;color:white;font-family:Arial;margin:0;padding:20px;}
.container{max-width:500px;margin:auto;background:#121212;padding:20px;border-radius:10px;}
.card{background:#1d1d1d;padding:12px;margin:10px 0;border-radius:8px;cursor:pointer;}
.card:hover{background:#2b2b2b;}
button{background:#ff5252;width:100%;padding:10px;border:none;border-radius:5px;color:white;margin-top:10px;}
.refunded{color:#00ff6a;font-weight:bold;}
.success{color:#00ff6a;}
.error{color:#ff4b4b;}
</style>
</head>

<body>

<div class="container">
<h2>Store Panel</h2>

<div id="status"></div>
<div>Email: <span id="email"></span></div>

<button onclick="logout()">Logout</button>

<h3>Last 2 Months Transactions</h3>
<div id="list"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth,onAuthStateChanged,signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore,doc,getDoc,updateDoc,arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={
 apiKey:"AIzaSyA7Tck7VFnldXnKj9fMpPc9bSWqgVQA8jU",
 authDomain:"bottlereward.firebaseapp.com",
 projectId:"bottlereward",
 storageBucket:"bottlereward.firebasestorage.app",
 messagingSenderId:"842823471278",
 appId:"1:842823471278:web:a7bbbb0291e581dcc71d3f"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth();
const db=getFirestore();

const status=document.getElementById("status");
const list=document.getElementById("list");

let storeEmail="";

// ---------- AUTH ----------
onAuthStateChanged(auth,async user=>{
 if(!user) return location="index.html";
 storeEmail=user.email;
 document.getElementById("email").innerText=user.email;

 const ref=doc(db,"stores",storeEmail);
 const snap=await getDoc(ref);

 if(!snap.exists()){
  status.innerHTML="❌ Not a store";
  await signOut(auth);
  return location="index.html";
 }

 loadTransactions();
});

// ---------- TIME HELPERS ----------
function toMs(t){
 if(t?.seconds) return t.seconds*1000;
 return new Date(t).getTime();
}

// ---------- LOAD ----------
async function loadTransactions(){
 const ref=doc(db,"stores",storeEmail);
 const snap=await getDoc(ref);
 let data=snap.data();

 if(!data.transactions||data.transactions.length===0){
  list.innerHTML="No transactions yet";
  return;
 }

 const TWO_MONTHS = 60*24*60*60*1000;
 const now = Date.now();

 let filtered = data.transactions.filter(t=>now-toMs(t.time)<=TWO_MONTHS);

 if(filtered.length===0){
  list.innerHTML="No transactions in last 2 months";
  return;
 }

 list.innerHTML="";

 filtered.reverse().forEach(t=>{
  let time=new Date(toMs(t.time)).toLocaleString();
  let card=document.createElement("div");
  card.className="card";

  card.innerHTML=
   `<b>Customer:</b> ${t.user}<br>
    <b>Points:</b> ${t.points}<br>
    <b>Time:</b> ${time}<br>
    ${t.refunded?'<span class="refunded">✔ REFUNDED</span>':'<span>Tap to refund</span>'}`;

  if(!t.refunded){
   card.onclick=()=>refund(t);
  }

  list.appendChild(card);
 });
}

// ---------- REFUND ----------
async function refund(t){
 if(!confirm("Refund to user?")) return;

 const userRef=doc(db,"users",t.user);
 const userSnap=await getDoc(userRef);
 if(!userSnap.exists()){
  alert("User not found");
  return;
 }

 let userData=userSnap.data();

 await updateDoc(userRef,{
  points:(userData.points||0)+t.points,
  history:arrayUnion({
   type:"Refund from Store",
   peer:storeEmail,
   points:t.points,
   time:new Date()
  })
 });

 const storeRef=doc(db,"stores",storeEmail);
 let storeData=(await getDoc(storeRef)).data();

 let updated=storeData.transactions.map(tr=>{
  if(tr.user===t.user && tr.points===t.points && !tr.refunded)
   return {...tr,refunded:true};
  return tr;
 });

 await updateDoc(storeRef,{transactions:updated});

 status.innerHTML="<span class='success'>Refunded ✔</span>";
 loadTransactions();
}

// ---------- LOGOUT ----------
window.logout=function(){
 signOut(auth).then(()=>location="index.html");
}
</script>
</body>
</html>
