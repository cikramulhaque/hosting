<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Transfer Points</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{background:#0d0d0d;color:white;font-family:Arial;margin:0;padding:20px;}
.container{max-width:450px;margin:auto;background:#121212;padding:20px;border-radius:10px;}
input{width:100%;padding:10px;margin:8px 0;border-radius:5px;border:none;}
button{width:100%;padding:10px;margin-top:10px;border-radius:5px;border:none;font-size:16px;}
.sendBtn{background:#00c853;color:white;}
.logoutBtn{background:#ff5252;color:white;margin-top:15px;}
.card{margin:10px 0;}
.historyBox{background:#1c1c1c;padding:10px;border-radius:5px;margin-top:10px;}
.success{color:#00ff6a;}
.error{color:#ff4b4b;}
</style>
</head>
<body>

<div class="container">
<h2>Customer Panel</h2>

<div class="card">Email: <span id="email"></span></div>
<div class="card">Points: <span id="points">0</span></div>
<div class="card">Bottles: <span id="bottles">0</span></div>

<input id="storeId" placeholder="Store Email">
<input id="amount" type="number" placeholder="Points to Send">
<button class="sendBtn" onclick="sendPoints()">SEND</button>

<button class="logoutBtn" onclick="logout()">LOGOUT</button>

<p id="msg"></p>

<h3>Transaction History</h3>
<div id="history"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { 
  getFirestore, 
  doc, 
  getDoc, 
  updateDoc, 
  setDoc, 
  arrayUnion 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA7Tck7VFnldXnKj9fMpPc9bSWqgVQA8jU",
  authDomain: "bottlereward.firebaseapp.com",
  projectId: "bottlereward",
  storageBucket: "bottlereward.firebasestorage.app",
  messagingSenderId: "842823471278",
  appId: "1:842823471278:web:a7bbbb0291e581dcc71d3f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

const msg=document.getElementById("msg");
let userEmail="";
let userDocRef;

// ---------- AUTH STATE ----------
onAuthStateChanged(auth, async (user)=>{
 if(!user) location="index.html";
 userEmail=user.email;
 document.getElementById("email").innerText=userEmail;

 userDocRef = doc(db,"users",userEmail);
 loadUser();
});

// ---------- LOAD USER ----------
async function loadUser(){
 let snap = await getDoc(userDocRef);
 if(!snap.exists()) return;

 let data = snap.data();
 document.getElementById("points").innerText=data.points || 0;
 document.getElementById("bottles").innerText=data.bottles || 0;

 loadHistory(data);
}

// ---------- TIME FORMAT ----------
function formatTime(t){
 if(t?.seconds) return new Date(t.seconds * 1000).toLocaleString();
 if(typeof t === "string" || typeof t === "number") return new Date(t).toLocaleString();
 if(t instanceof Date) return t.toLocaleString();
 return "Unknown Time";
}

// ---------- LOAD HISTORY ----------
function loadHistory(data){
 const box=document.getElementById("history");
 box.innerHTML="";
 if(!data.history || data.history.length==0){
  box.innerHTML="No transactions yet";
  return;
 }
 data.history.slice().reverse().forEach(t=>{
  let d=document.createElement("div");
  d.className="historyBox";
  d.innerHTML=`Store: ${t.store}<br>Points: ${t.points}<br>Time: ${formatTime(t.time)}`;
  box.appendChild(d);
 });
}

// ---------- SEND POINTS ----------
window.sendPoints = async function(){
 msg.innerHTML="Processing...";

 let liveSnap = await getDoc(userDocRef);
 let live = liveSnap.data();
 let currentPoints = Number(live.points || 0);

 let pts = Number(document.getElementById("amount").value);
 let store = document.getElementById("storeId").value;

 if(!pts || pts<=0){
   msg.innerHTML="<span class='error'>Enter valid amount ❌</span>";
   return;
 }
 if(currentPoints <= 0){
   msg.innerHTML="<span class='error'>You have 0 Points ❌</span>";
   return;
 }
 if(pts > currentPoints){
   msg.innerHTML="<span class='error'>Insufficient Points ❌</span>";
   return;
 }

 await updateDoc(userDocRef,{
   points: currentPoints - pts,
   history: arrayUnion({store:store,points:pts,time:new Date()})
 });

 const storeRef=doc(db,"stores",store);
 let s=await getDoc(storeRef);
 if(!s.exists()) await setDoc(storeRef,{name:store,transactions:[]});

 await updateDoc(storeRef,{
   transactions:arrayUnion({user:userEmail,points:pts,time:new Date()})
 });

 msg.innerHTML="<span class='success'>Points Sent Successfully ✔</span>";
 loadUser();
}

// ---------- LOGOUT ----------
window.logout = function(){
 signOut(auth).then(()=>{
   location="index.html";
 });
}

</script>
</body>
</html>
