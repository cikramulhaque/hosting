<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Wallet & Transfer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{background:#0d0d0d;color:white;font-family:Arial;margin:0;padding:20px;}
.container{max-width:500px;margin:auto;background:#121212;padding:20px;border-radius:10px;}
.card{margin:10px 0;}
.box{background:#1c1c1c;padding:10px;border-radius:8px;margin-top:12px;}
input{width:100%;padding:10px;margin:8px 0;border-radius:5px;border:none;}
button{width:100%;padding:10px;margin-top:10px;border-radius:5px;border:none;font-size:16px;}
.btnGreen{background:#00c853;color:white;}
.btnRed{background:#ff5252;color:white;}
.historyBox{background:#1f1f1f;padding:10px;border-radius:5px;margin-top:10px;}
.success{color:#00ff6a;}
.error{color:#ff4b4b;}
</style>
</head>
<body>

<div class="container">
<h2>Customer Wallet</h2>

<div class="card">Email: <span id="email"></span></div>
<div class="card">Points: <span id="points">0</span></div>
<div class="card">Bottles: <span id="bottles">0</span></div>

<div class="box">
<h3>Send Points</h3>
<input id="receiver" placeholder="Enter User / Store Email">
<input id="amount" type="number" placeholder="Points">
<button class="btnGreen" onclick="sendPoints()">Send Points</button>
</div>

<button class="btnRed" onclick="logout()">Logout</button>

<p id="msg"></p>

<h3>Last 2 Weeks History</h3>
<div id="history"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore,doc,getDoc,updateDoc,setDoc,arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyA7Tck7VFnldXnKj9fMpPc9bSWqgVQA8jU",
  authDomain:"bottlereward.firebaseapp.com",
  projectId:"bottlereward",
  storageBucket:"bottlereward.firebasestorage.app",
  messagingSenderId:"842823471278",
  appId:"1:842823471278:web:a7bbbb0291e581dcc71d3f"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth();
const db=getFirestore();

const msg=document.getElementById("msg");
let userEmail="",userDocRef;

onAuthStateChanged(auth,async user=>{
 if(!user) location="index.html";
 userEmail=user.email;
 document.getElementById("email").innerText=userEmail;
 userDocRef=doc(db,"users",userEmail);
 loadUser();
});

// ---------- LOAD ----------
async function loadUser(){
 let snap=await getDoc(userDocRef);
 if(!snap.exists()) return;
 let data=snap.data();
 document.getElementById("points").innerText=data.points||0;
 document.getElementById("bottles").innerText=data.bottles||0;
 loadHistory(data);
}

// ---------- FORMAT ----------
function toMs(t){
 if(t?.seconds) return t.seconds*1000;
 return new Date(t).getTime();
}
function formatTime(t){
 return new Date(toMs(t)).toLocaleString();
}

// ---------- LAST 2 WEEKS FILTER ----------
function loadHistory(data){
 const box=document.getElementById("history");
 box.innerHTML="";
 if(!data.history||data.history.length===0){
  box.innerHTML="No transactions yet";
  return;
 }

 const TWO_WEEKS = 14*24*60*60*1000;
 const now=Date.now();

 let filtered=data.history.filter(t=>now-toMs(t.time)<=TWO_WEEKS);

 if(filtered.length===0){
  box.innerHTML="No transactions in last 2 weeks";
  return;
 }

 filtered.reverse().forEach(t=>{
  let div=document.createElement("div");
  div.className="historyBox";
  div.innerHTML=
   `<b>Type:</b> ${t.type}<br>
    <b>Peer:</b> ${t.peer}<br>
    <b>Points:</b> ${t.points}<br>
    <b>Time:</b> ${formatTime(t.time)}`;
  box.appendChild(div);
 });
}

// ---------- SEND ----------
window.sendPoints=async function(){
 msg.innerHTML="Processing...";
 let amount=document.getElementById("amount");
 let receiver=document.getElementById("receiver");
 let pts=Number(amount.value);
 let rec=receiver.value;

 let live=(await getDoc(userDocRef)).data();
 let balance=Number(live.points||0);

 if(pts<=0) return msg.innerHTML="<span class='error'>Enter valid points ❌</span>";
 if(balance<=0) return msg.innerHTML="<span class='error'>Balance 0 ❌</span>";
 if(pts>balance) return msg.innerHTML="<span class='error'>Insufficient Points ❌</span>";

 const userRef=doc(db,"users",rec);
 const storeRef=doc(db,"stores",rec);
 const userSnap=await getDoc(userRef);
 const storeSnap=await getDoc(storeRef);

 // USER
 if(userSnap.exists()){
  let recData=userSnap.data();

  await updateDoc(userDocRef,{
   points:balance-pts,
   history:arrayUnion({type:"Send to User",peer:rec,points:pts,time:new Date()})
  });

  await updateDoc(userRef,{
   points:(recData.points||0)+pts,
   history:arrayUnion({type:"Received from User",peer:userEmail,points:pts,time:new Date()})
  });

  msg.innerHTML="<span class='success'>Sent to User ✔</span>";
  amount.value=""; receiver.value="";
  return loadUser();
 }

 // STORE
 if(storeSnap.exists()){
  await updateDoc(userDocRef,{
   points:balance-pts,
   history:arrayUnion({type:"Send to Store",peer:rec,points:pts,time:new Date()})
  });

  await updateDoc(storeRef,{
   transactions:arrayUnion({user:userEmail,points:pts,time:new Date(),refunded:false})
  });

  msg.innerHTML="<span class='success'>Sent to Store ✔</span>";
  amount.value=""; receiver.value="";
  return loadUser();
 }

 msg.innerHTML="<span class='error'>Receiver Not Found ❌</span>";
}

// ---------- LOGOUT ----------
window.logout=function(){
 signOut(auth).then(()=>location="index.html");
}
</script>
</body>
</html>
